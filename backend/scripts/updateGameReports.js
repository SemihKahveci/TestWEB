require('dotenv').config();
const mongoose = require('mongoose');
const Game = require('../models/game');
const UserCode = require('../models/userCode');

// MongoDB baƒülantƒ±sƒ±
mongoose.connect(process.env.MONGODB_URI, {
    useNewUrlParser: true,
    useUnifiedTopology: true
});

class GameReportUpdater {
    constructor() {
        this.updatedCount = 0;
        this.errorCount = 0;
    }

    // Rapor e≈üle≈ütirme fonksiyonu (yeni tam e≈üle≈üme sistemi)
    async getReportsByAnswerType(answers) {
        try {
            // T√ºm yetenek t√ºrlerini gruplandƒ±r
            const byAnswers = answers.filter(answer => answer.answerSubCategory === 'BY');
            const moAnswers = answers.filter(answer => answer.answerSubCategory === 'MO');
            const ieAnswers = answers.filter(answer => answer.answerSubCategory === 'IE');
            const idikAnswers = answers.filter(answer => answer.answerSubCategory === 'IDIK');
            
            // Cevaplarƒ± answerType1 deƒüerlerini al
            const byAnswerTypes = byAnswers.map(answer => answer.answerType1);
            const moAnswerTypes = moAnswers.map(answer => answer.answerType1);
            const ieAnswerTypes = ieAnswers.map(answer => answer.answerType1);
            const idikAnswerTypes = idikAnswers.map(answer => answer.answerType1);

            // Bo≈ü olmayan cevaplarƒ± filtrele
            const validByAnswerTypes = byAnswerTypes.filter(type => type && type !== '-');
            const validMoAnswerTypes = moAnswerTypes.filter(type => type && type !== '-');
            const validIeAnswerTypes = ieAnswerTypes.filter(type => type && type !== '-');
            const validIdikAnswerTypes = idikAnswerTypes.filter(type => type && type !== '-');

            // Cevaplarƒ± string formatƒ±na √ßevir
            const byAnswerString = validByAnswerTypes.join(', ');
            const moAnswerString = validMoAnswerTypes.join(', ');
            const ieAnswerString = validIeAnswerTypes.join(', ');
            const idikAnswerString = validIdikAnswerTypes.join(', ');

            let results = [];

            // BY raporlarƒ±nƒ± kontrol et (Venus - Belirsizlik Y√∂netimi)
            if (byAnswerString) {
                const byAnswerStringNoSpace = byAnswerString.replace(/, /g, ',');
                
                const matchedBY = await mongoose.connection.collection('evaluationanswers').findOne({
                    $or: [
                        { Cevaplar: byAnswerString },
                        { Cevaplar: byAnswerStringNoSpace }
                    ]
                });

                if (matchedBY) {
                    const byResult = await mongoose.connection.collection('evaluationresults').findOne({ ID: matchedBY.ID });
                    if (byResult) {
                        results.push({ type: 'BY', data: byResult });
                    }
                }
            }

            // MO raporlarƒ±nƒ± kontrol et (Venus - M√º≈üteri Odaklƒ±lƒ±k)
            if (moAnswerString) {
                const moAnswerStringNoSpace = moAnswerString.replace(/, /g, ',');
                
                const matchedMO = await mongoose.connection.collection('evaluationanswersMY').findOne({
                    $or: [
                        { Cevaplar: moAnswerString },
                        { Cevaplar: moAnswerStringNoSpace }
                    ]
                });

                if (matchedMO) {
                    const moResult = await mongoose.connection.collection('evaluationresultsMY').findOne({ ID: matchedMO.ID });
                    if (moResult) {
                        results.push({ type: 'MO', data: moResult });
                    }
                }
            }

            // IE raporlarƒ±nƒ± kontrol et (Titan - ƒ∞nsanlarƒ± Etkileme)
            if (ieAnswerString) {
                const ieAnswerStringNoSpace = ieAnswerString.replace(/, /g, ',');
                
                const matchedIE = await mongoose.connection.collection('evaluationanswersHI').findOne({
                    $or: [
                        { Cevaplar: ieAnswerString },
                        { Cevaplar: ieAnswerStringNoSpace }
                    ]
                });

                if (matchedIE) {
                    const ieResult = await mongoose.connection.collection('evaluationresultsHI').findOne({ ID: matchedIE.ID });
                    if (ieResult) {
                        results.push({ type: 'IE', data: ieResult });
                    }
                }
            }

            // IDIK raporlarƒ±nƒ± kontrol et (Titan - G√ºven Veren ƒ∞≈übirlik√ßi ve Sinerji)
            if (idikAnswerString) {
                const idikAnswerStringNoSpace = idikAnswerString.replace(/, /g, ',');
                
                const matchedIDIK = await mongoose.connection.collection('evaluationanswersTW').findOne({
                    $or: [
                        { Cevaplar: idikAnswerString },
                        { Cevaplar: idikAnswerStringNoSpace }
                    ]
                });

                if (matchedIDIK) {
                    const idikResult = await mongoose.connection.collection('evaluationresultsTW').findOne({ ID: matchedIDIK.ID });
                    if (idikResult) {
                        results.push({ type: 'IDIK', data: idikResult });
                    }
                }
            }

            return results.length > 0 ? results : null;

        } catch (error) {
            console.error('Rapor sorgulama hatasƒ±:', error);
            return null;
        }
    }

    // Tek bir oyunu g√ºncelle
    async updateGameReports(game) {
        try {
            console.log(`\nüîÑ G√ºncelleniyor: ${game.playerCode} (Section: ${game.section})`);
            
            if (!game.answers || game.answers.length === 0) {
                console.log('‚ùå Cevap bulunamadƒ±, atlanƒ±yor...');
                return false;
            }

            // Yeni rapor e≈üle≈ütirme sistemi ile raporlarƒ± bul
            const newEvaluationResult = await this.getReportsByAnswerType(game.answers);
            
            if (!newEvaluationResult) {
                console.log('‚ùå Yeni rapor bulunamadƒ±');
                return false;
            }

            // Eski ve yeni raporlarƒ± kar≈üƒ±la≈ütƒ±r
            const oldReports = Array.isArray(game.evaluationResult) ? game.evaluationResult : [game.evaluationResult];
            const oldReportIds = oldReports.map(r => r?.data?.ID).filter(Boolean);
            const newReportIds = newEvaluationResult.map(r => r.data.ID);

            console.log(`üìä Eski raporlar: [${oldReportIds.join(', ')}]`);
            console.log(`üìä Yeni raporlar: [${newReportIds.join(', ')}]`);

            // Eƒüer raporlar farklƒ±ysa g√ºncelle
            const isDifferent = JSON.stringify(oldReportIds.sort()) !== JSON.stringify(newReportIds.sort());
            
            if (isDifferent) {
                // Game modelini g√ºncelle
                await Game.findByIdAndUpdate(game._id, {
                    evaluationResult: newEvaluationResult
                });

                // UserCode modelini de g√ºncelle
                await UserCode.findOneAndUpdate(
                    { code: game.playerCode },
                    { evaluationResult: newEvaluationResult }
                );

                console.log('‚úÖ Raporlar g√ºncellendi!');
                this.updatedCount++;
                return true;
            } else {
                console.log('‚ÑπÔ∏è Raporlar aynƒ±, g√ºncelleme gerekmiyor');
                return false;
            }

        } catch (error) {
            console.error(`‚ùå Hata (${game.playerCode}):`, error.message);
            this.errorCount++;
            return false;
        }
    }

    // T√ºm oyunlarƒ± g√ºncelle
    async updateAllGames() {
        try {
            console.log('üöÄ Oyun raporlarƒ± g√ºncelleme i≈ülemi ba≈ülƒ±yor...\n');

            // T√ºm tamamlanmƒ±≈ü oyunlarƒ± bul
            const games = await Game.find({
                evaluationResult: { $exists: true, $ne: null }
            }).sort({ date: -1 });

            console.log(`üìã Toplam ${games.length} oyun bulundu\n`);

            for (const game of games) {
                await this.updateGameReports(game);
            }

            console.log('\nüéâ G√ºncelleme tamamlandƒ±!');
            console.log(`‚úÖ G√ºncellenen: ${this.updatedCount} oyun`);
            console.log(`‚ùå Hata olan: ${this.errorCount} oyun`);
            console.log(`üìä Toplam: ${games.length} oyun`);

        } catch (error) {
            console.error('‚ùå Genel hata:', error);
        } finally {
            mongoose.connection.close();
        }
    }

    // Belirli bir kodu g√ºncelle
    async updateSpecificCode(playerCode) {
        try {
            console.log(`üéØ Belirli kod g√ºncelleniyor: ${playerCode}\n`);

            const games = await Game.find({ playerCode });
            
            if (games.length === 0) {
                console.log('‚ùå Bu kod i√ßin oyun bulunamadƒ±');
                return;
            }

            console.log(`üìã ${games.length} oyun bulundu\n`);

            for (const game of games) {
                await this.updateGameReports(game);
            }

            console.log('\nüéâ G√ºncelleme tamamlandƒ±!');
            console.log(`‚úÖ G√ºncellenen: ${this.updatedCount} oyun`);

        } catch (error) {
            console.error('‚ùå Hata:', error);
        } finally {
            mongoose.connection.close();
        }
    }
}

// Script kullanƒ±mƒ±
async function main() {
    const updater = new GameReportUpdater();
    
    // Komut satƒ±rƒ± arg√ºmanlarƒ±nƒ± kontrol et
    const args = process.argv.slice(2);
    
    if (args.length > 0) {
        // Belirli bir kod g√ºncelle
        await updater.updateSpecificCode(args[0]);
    } else {
        // T√ºm oyunlarƒ± g√ºncelle
        await updater.updateAllGames();
    }
}

// Script'i √ßalƒ±≈ütƒ±r
if (require.main === module) {
    main().catch(console.error);
}

module.exports = GameReportUpdater;
