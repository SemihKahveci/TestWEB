<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Andron Games - Sonuçlar</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background: #f5f5f5;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
            font-weight: 500;
        }

        .header .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header .user-info span {
            color: #666;
        }

        .header .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .header .logout-btn:hover {
            background: #c82333;
        }

        .nav-links {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .nav-links a {
            color: #007bff;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #0056b3;
        }

        .card {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-form input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .search-form button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .search-form button:hover {
            background: #0056b3;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .checkbox-container {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-container label {
            font-weight: bold;
            cursor: pointer;
        }

        .error {
            color: #ff0000;
            margin-top: 10px;
        }

        .section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .section h3 {
            color: #444;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .section p {
            margin-bottom: 10px;
            line-height: 1.6;
            color: #666;
        }

        .section ul {
            list-style-type: disc;
            margin-left: 20px;
        }

        .section li {
            margin-bottom: 8px;
            color: #666;
        }

        #resultsList {
            margin-top: 20px;
        }

        .result-item {
            background: #fff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .result-item h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .result-item p {
            color: #666;
            margin-bottom: 5px;
        }

        .result-item button {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sonuçlar</h1>
            <div class="user-info">
                <span id="userEmail"></span>
                <a href="admin-panel.html" class="btn">Ana Sayfa</a>
                <button class="logout-btn" onclick="logout()">Çıkış Yap</button>
            </div>
        </div>

        <div class="nav-links">
            <a href="index.html">Kod Üretme</a>
        </div>

        <div class="card">
            <h2>Değerlendirme Sonuçları</h2>
            <form class="search-form" onsubmit="searchEvaluation(event)">
                <input type="text" id="evaluationId" placeholder="ID ile ara..." required>
                <button type="submit">Ara</button>
            </form>
            <div id="evaluationResult"></div>
            <div id="resultsList"></div>
        </div>
    </div>

    <script>
        // Kullanıcı oturumunu kontrol et
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'admin.html';
                return;
            }
            const userEmail = localStorage.getItem('userEmail');
            document.getElementById('userEmail').textContent = userEmail;
        }

        // Sayfa yüklendiğinde oturumu kontrol et
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadAllResults(); // Tüm sonuçları yükle
        });

        // Çıkış yap
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userEmail');
            window.location.href = 'admin.html';
        }

        // ID ile arama yap
        async function searchEvaluation(event) {
            event.preventDefault();
            const id = document.getElementById('evaluationId').value;
            try {
                const response = await fetch(`/api/evaluation/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Değerlendirme bulunamadı');
                }
                
                const evaluation = await response.json();
                displayEvaluation(evaluation);
            } catch (error) {
                document.getElementById('evaluationResult').innerHTML = `
                    <div class="error">${error.message}</div>
                `;
            }
        }

        // Tüm sonuçları yükle
        async function loadAllResults() {
            try {
                console.log('Sonuçlar yükleniyor...');
                const response = await fetch('/api/results', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Sonuçlar bulunamadı');
                }
                
                const results = await response.json();
                console.log('Yüklenen sonuçlar:', results);
                
                if (results && results.length > 0) {
                    displayAllResults(results);
                } else {
                    document.getElementById('resultsList').innerHTML = '<p>Gösterilecek sonuç bulunamadı.</p>';
                }
            } catch (error) {
                console.error('Sonuçlar yüklenirken hata:', error);
                document.getElementById('resultsList').innerHTML = `
                    <div class="error">${error.message}</div>
                `;
            }
        }

        // Tüm sonuçları göster
        function displayAllResults(results) {
            const resultsListDiv = document.getElementById('resultsList');
            resultsListDiv.innerHTML = '';
            
            // Sadece değerlendirme sonucu olan oyunları filtrele
            const resultsWithEvaluation = results.filter(result => result.evaluationId);
            
            if (!resultsWithEvaluation || resultsWithEvaluation.length === 0) {
                resultsListDiv.innerHTML = '<p>Gösterilecek değerlendirme sonucu bulunamadı.</p>';
                return;
            }
            
            resultsWithEvaluation.forEach(result => {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                
                resultItem.innerHTML = `
                    <h3>Oyuncu Kodu: ${result.playerCode}</h3>
                    <p>Bölüm: ${result.section}</p>
                    <p>Toplam Puan: ${result.totalScore}</p>
                    <p>Tarih: ${new Date(result.date).toLocaleString('tr-TR')}</p>
                    <button onclick="searchEvaluationById('${result.evaluationId}')" class="btn">Değerlendirme Sonucu</button>
                `;
                resultsListDiv.appendChild(resultItem);
            });
        }

        // ID ile değerlendirme ara
        async function searchEvaluationById(id) {
            try {
                console.log('Değerlendirme aranıyor, ID:', id);
                const response = await fetch(`/api/evaluation/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Değerlendirme bulunamadı');
                }
                
                const evaluation = await response.json();
                console.log('Bulunan değerlendirme:', evaluation);
                
                if (evaluation) {
                    displayEvaluation(evaluation);
                    // Değerlendirme sonucunu göster
                    document.getElementById('evaluationResult').scrollIntoView({ behavior: 'smooth' });
                } else {
                    document.getElementById('evaluationResult').innerHTML = `
                        <div class="error">Değerlendirme bulunamadı.</div>
                    `;
                }
            } catch (error) {
                console.error('Değerlendirme aranırken hata:', error);
                document.getElementById('evaluationResult').innerHTML = `
                    <div class="error">${error.message}</div>
                `;
            }
        }

        // Değerlendirmeleri göster
        function displayEvaluations(evaluations) {
            const resultsListDiv = document.getElementById('resultsList');
            resultsListDiv.innerHTML = '';
            
            if (evaluations.length === 0) {
                resultsListDiv.innerHTML = '<p>Gösterilecek değerlendirme bulunamadı.</p>';
                return;
            }
            
            evaluations.forEach(evaluation => {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                resultItem.innerHTML = `
                    <h3>Değerlendirme ID: ${evaluation.ID}</h3>
                    <p>Genel Değerlendirme: ${evaluation['Genel Değerlendirme'] || 'Bulunamadı'}</p>
                    <button onclick="displayEvaluation(${JSON.stringify(evaluation)})" class="btn">Detayları Göster</button>
                `;
                resultsListDiv.appendChild(resultItem);
            });
        }

        // Değerlendirme sonucunu göster
        function displayEvaluation(evaluation) {
            console.log('Değerlendirme gösteriliyor:', evaluation);
            const resultDiv = document.getElementById('evaluationResult');
            
            if (!evaluation) {
                resultDiv.innerHTML = '<div class="error">Değerlendirme verisi bulunamadı.</div>';
                return;
            }
            
            // Gelişim önerilerini ayrı başlıklar altında oluştur
            let gelisimOnerileriHTML = '';
            const gelisimOnerileriKeys = ['Gelişim Önerileri -1', 'Gelişim Önerileri -2', 'Gelişim Önerileri - 3'];
            
            gelisimOnerileriKeys.forEach((key, index) => {
                if (evaluation[key]) {
                    gelisimOnerileriHTML += `
                        <div class="subsection">
                            <h3>Gelişim Önerisi ${index + 1}</h3>
                            <p>${evaluation[key]}</p>
                        </div>
                    `;
                }
            });

            resultDiv.innerHTML = `
                <div style="text-align: right; margin-bottom: 20px;">
                    <button onclick="showPDFOptions('${evaluation.ID}')" class="btn btn-success">
                        PDF İndir
                    </button>
                </div>
                <div class="section">
                    <h2>Genel Değerlendirme</h2>
                    <div class="checkbox-container">
                        <input type="checkbox" id="generalEvaluation" checked>
                        <label for="generalEvaluation">Genel Değerlendirme</label>
                    </div>
                    <p>${evaluation['Genel Değerlendirme'] || 'Bulunamadı'}</p>
                </div>
                <div class="section">
                    <h2>Güçlü Yönler</h2>
                    <div class="checkbox-container">
                        <input type="checkbox" id="strengths" checked>
                        <label for="strengths">Güçlü Yönler</label>
                    </div>
                    <p>${evaluation['Güçlü Yönler'] || 'Bulunamadı'}</p>
                </div>
                <div class="section">
                    <h2>Gelişim Alanları</h2>
                    <div class="checkbox-container">
                        <input type="checkbox" id="development" checked>
                        <label for="development">Gelişim Alanları</label>
                    </div>
                    <p>${evaluation['Gelişim Alanları'] || 'Bulunamadı'}</p>
                </div>
                <div class="section">
                    <h2>Mülakat Soruları</h2>
                    <div class="checkbox-container">
                        <input type="checkbox" id="interviewQuestions" checked>
                        <label for="interviewQuestions">Mülakat Soruları</label>
                    </div>
                    <p>${evaluation['Mülakat Soruları'] || 'Bulunamadı'}</p>
                </div>
                <div class="section">
                    <h2>Neden Bu Sorular?</h2>
                    <div class="checkbox-container">
                        <input type="checkbox" id="whyTheseQuestions" checked>
                        <label for="whyTheseQuestions">Neden Bu Sorular?</label>
                    </div>
                    <p>${evaluation['Neden Bu Sorular?'] || 'Bulunamadı'}</p>
                </div>
                <div class="section">
                    <h2>Gelişim Önerileri</h2>
                    <div class="checkbox-container">
                        <input type="checkbox" id="developmentSuggestions" checked>
                        <label for="developmentSuggestions">Gelişim Önerileri</label>
                    </div>
                    ${gelisimOnerileriHTML || '<p>Gelişim önerisi bulunamadı.</p>'}
                </div>
            `;
        }

        // PDF seçeneklerini göster
        function showPDFOptions(id) {
            const selectedSections = {
                generalEvaluation: document.getElementById('generalEvaluation').checked,
                strengths: document.getElementById('strengths').checked,
                development: document.getElementById('development').checked,
                interviewQuestions: document.getElementById('interviewQuestions').checked,
                whyTheseQuestions: document.getElementById('whyTheseQuestions').checked,
                developmentSuggestions: document.getElementById('developmentSuggestions').checked
            };

            generatePDF(id, selectedSections);
        }

        // PDF oluştur
        async function generatePDF(id, selectedSections) {
            try {
                const response = await fetch(`/api/evaluation/${id}/pdf`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(selectedSections)
                });

                if (!response.ok) {
                    throw new Error('PDF oluşturulurken bir hata oluştu');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `evaluation_${id}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('PDF oluşturma hatası:', error);
                alert('PDF oluşturulurken bir hata oluştu: ' + error.message);
            }
        }
    </script>
</body>
</html>